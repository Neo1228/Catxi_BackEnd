<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="009-fix-report-nullable-constraints" author="system">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="report"/>
        </preConditions>
        
        <comment>Fix Report table nullable constraints to match entity requirements</comment>
        
        <!-- First, delete any rows with NULL values as they are invalid reports -->
        <sql>
            DELETE FROM report WHERE reporter_id IS NULL OR reported_member_id IS NULL;
        </sql>
        
        <!-- Add NOT NULL constraints -->
        <addNotNullConstraint 
            tableName="report" 
            columnName="reporter_id" 
            columnDataType="BIGINT"/>
            
        <addNotNullConstraint 
            tableName="report" 
            columnName="reported_member_id" 
            columnDataType="BIGINT"/>
        
        <rollback>
            <dropNotNullConstraint tableName="report" columnName="reporter_id" columnDataType="BIGINT"/>
            <dropNotNullConstraint tableName="report" columnName="reported_member_id" columnDataType="BIGINT"/>
        </rollback>
        
    </changeSet>

</databaseChangeLog>