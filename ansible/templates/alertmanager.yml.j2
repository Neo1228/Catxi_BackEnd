global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'team', 'service', 'severity']
  group_wait: 10s
  group_interval: 30s
  repeat_interval: 4h
  receiver: 'catxi-default'
  routes:
  # Critical alerts - immediate notification
  - match:
      severity: critical
    receiver: 'catxi-critical'
    repeat_interval: 2m
    group_wait: 5s
  # Warning alerts - less frequent
  - match:
      severity: warning
    receiver: 'catxi-warning'
    repeat_interval: 30m
  # Info alerts - low frequency
  - match:
      severity: info
    receiver: 'catxi-info'
    repeat_interval: 2h

receivers:
- name: 'catxi-default'
{% if lookup('env', 'DISCORD_WEBHOOK_URL') %}
  discord_configs:
  - webhook_url: '{{ lookup("env", "DISCORD_WEBHOOK_URL") }}'
    send_resolved: true
    title: "🔔 Catxi 알림"
    content: |
      {% raw %}**{{ .GroupLabels.severity }} 알림 - {{ .GroupLabels.team }} 팀**

      **📊 서비스:** {{ .GroupLabels.service }}
      **⏰ 시간:** {{ .StartsAt.Format "15:04:05" }}

      {{ range .Alerts }}**{{ .Annotations.summary }}**
      {{ .Annotations.description }}
      ---{{ end }}{% endraw %}
{% else %}
  webhook_configs: []
{% endif %}

- name: 'catxi-critical'
{% if lookup('env', 'DISCORD_WEBHOOK_URL') %}
  discord_configs:
  - webhook_url: '{{ lookup("env", "DISCORD_WEBHOOK_URL") }}'
    send_resolved: true
    title: "🚨 긴급 장애 알림"
    content: |
      {% raw %}@everyone **CRITICAL ALERT**

      **🎯 서비스:** {{ .GroupLabels.service }}
      **👥 담당팀:** {{ .GroupLabels.team }}
      **⏰ 발생시간:** {{ .StartsAt.Format "15:04:05" }}
      **🔥 우선순위:** {{ .GroupLabels.priority | default "P0" }}

      {{ range .Alerts }}**⚡ {{ .Annotations.summary }}**
      {{ .Annotations.description }}
      {{ if .Annotations.runbook_url }}
      **📖 대응가이드:** {{ .Annotations.runbook_url }}{{ end }}
      ════════════════════════════════{{ end }}{% endraw %}
{% else %}
  webhook_configs: []
{% endif %}

- name: 'catxi-warning'
{% if lookup('env', 'DISCORD_WEBHOOK_URL') %}
  discord_configs:
  - webhook_url: '{{ lookup("env", "DISCORD_WEBHOOK_URL") }}'
    send_resolved: true
    title: "⚠️ 경고 알림"
    content: |
      {% raw %}**{{ .GroupLabels.team }} 팀 경고**

      **🏷️ 서비스:** {{ .GroupLabels.service }}
      **📊 우선순위:** {{ .GroupLabels.priority | default "P2" }}
      **⏰ 발생시간:** {{ .StartsAt.Format "15:04:05" }}

      {{ range .Alerts }}**⚠️ {{ .Annotations.summary }}**
      {{ .Annotations.description }}
      {{ if .Annotations.runbook_url }}
      **📖 대응가이드:** {{ .Annotations.runbook_url }}{{ end }}
      ────────────────────────────────────{{ end }}{% endraw %}
{% else %}
  webhook_configs: []
{% endif %}

- name: 'catxi-info'
{% if lookup('env', 'DISCORD_WEBHOOK_URL') %}
  discord_configs:
  - webhook_url: '{{ lookup("env", "DISCORD_WEBHOOK_URL") }}'
    send_resolved: true
    title: "ℹ️ 모니터링 정보"
    content: |
      {% raw %}**{{ .GroupLabels.team }} 팀 정보**

      **서비스:** {{ .GroupLabels.service }}
      **시간:** {{ .StartsAt.Format "15:04:05" }}

      {{ range .Alerts }}{{ .Annotations.summary }}
      {{ .Annotations.description }}{{ end }}{% endraw %}
{% else %}
  webhook_configs: []
{% endif %}

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']